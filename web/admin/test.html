<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Diagnostics - Catering Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .logged-in {
            background: #28a745;
            color: white;
        }
        
        .logged-out {
            background: #dc3545;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üîß Catering System Diagnostics</h1>
            <div>
                <span id="loginStatus" class="status-badge">Checking...</span>
            </div>
        </div>

        <div class="alert alert-info">
            <strong>üéØ How to use this tool:</strong>
            <ol class="mb-0 mt-2">
                <li>First, click "Test Login" to authenticate</li>
                <li>Then run "Run All Tests" to check all endpoints</li>
                <li>If you see errors, check the detailed error messages below</li>
            </ol>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üìã System Information</h5>
            </div>
            <div class="card-body">
                <div id="systemInfo"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üîê Authentication Tests</h5>
            </div>
            <div class="card-body">
                <div class="btn-group mb-3" role="group">
                    <button class="btn btn-success" onclick="testLogin()">
                        <i>üîë</i> Test Login
                    </button>
                    <button class="btn btn-info" onclick="checkSession()">
                        <i>üîç</i> Check Session
                    </button>
                    <button class="btn btn-warning" onclick="testLogout()">
                        <i>üö™</i> Test Logout
                    </button>
                </div>
                <div id="authResults"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üß™ API Endpoint Tests</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary btn-lg mb-3" onclick="runAllTests()">
                    ‚ñ∂Ô∏è Run All Tests
                </button>
                <div id="testResults"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üîó Quick Links</h5>
            </div>
            <div class="card-body">
                <a href="index.html" class="btn btn-secondary me-2">üè† Go to Login Page</a>
                <a href="dashboard.html" class="btn btn-secondary me-2">üìä Go to Dashboard</a>
                <button class="btn btn-danger" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '../api/';
        let isLoggedIn = false;

        // Display system info on load
        window.addEventListener('load', function() {
            displaySystemInfo();
            checkSessionStatus();
        });

        function displaySystemInfo() {
            const info = `
                <table class="table table-sm">
                    <tr>
                        <th width="30%">Current URL:</th>
                        <td>${window.location.href}</td>
                    </tr>
                    <tr>
                        <th>API Base Path:</th>
                        <td><code>${API_BASE}</code></td>
                    </tr>
                    <tr>
                        <th>Full API URL:</th>
                        <td><code>${window.location.origin}${window.location.pathname.replace('admin/test.html', '')}${API_BASE}</code></td>
                    </tr>
                    <tr>
                        <th>Browser:</th>
                        <td>${navigator.userAgent.substring(0, 100)}...</td>
                    </tr>
                    <tr>
                        <th>Cookies Enabled:</th>
                        <td>${navigator.cookieEnabled ? '‚úÖ Yes' : '‚ùå No'}</td>
                    </tr>
                    <tr>
                        <th>Current Time:</th>
                        <td>${new Date().toLocaleString()}</td>
                    </tr>
                </table>
            `;
            document.getElementById('systemInfo').innerHTML = info;
        }

        async function checkSessionStatus() {
            try {
                const response = await fetch(API_BASE + 'auth/check.php', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();

                const statusEl = document.getElementById('loginStatus');
                if (data.success && data.data && data.data.authenticated) {
                    statusEl.textContent = `‚úÖ Logged in as: ${data.data.email}`;
                    statusEl.className = 'status-badge logged-in';
                    isLoggedIn = true;
                } else {
                    statusEl.textContent = '‚ùå Not Logged In';
                    statusEl.className = 'status-badge logged-out';
                    isLoggedIn = false;
                }
            } catch (error) {
                const statusEl = document.getElementById('loginStatus');
                statusEl.textContent = '‚ö†Ô∏è Cannot Check Status';
                statusEl.className = 'status-badge warning';
            }
        }

        function addResult(title, success, message, data = null, container = 'testResults') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'success' : 'error'}`;

            let html = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong style="font-size: 16px;">${success ? '‚úÖ' : '‚ùå'} ${title}</strong>
                        <p class="mb-2 mt-2">${message}</p>
                    </div>
                    <small>${new Date().toLocaleTimeString()}</small>
                </div>
            `;

            if (data) {
                html += `<details class="mt-2">
                    <summary style="cursor: pointer; color: #007bff;">üìã View Details</summary>
                    <pre class="mt-2">${JSON.stringify(data, null, 2)}</pre>
                </details>`;
            }

            resultDiv.innerHTML = html;
            document.getElementById(container).appendChild(resultDiv);
        }

        function addInfo(message, container = 'testResults') {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'test-result info';
            infoDiv.innerHTML = `<strong>‚ÑπÔ∏è Info:</strong> ${message}`;
            document.getElementById(container).appendChild(infoDiv);
        }

        async function testEndpoint(name, url, method = 'GET', body = null, requiresAuth = true) {
            try {
                console.log(`Testing: ${name} - ${url}`);

                const options = {
                    method: method,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);

                // Log response details
                console.log(`Response status: ${response.status}`);

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error(`Invalid JSON response. Status: ${response.status}`);
                }

                console.log('Response data:', data);

                if (data.success) {
                    addResult(
                        name,
                        true,
                        `‚úì Success: ${data.message}`,
                        data
                    );
                    return true;
                } else {
                    addResult(
                        name,
                        false,
                        `‚úó Failed: ${data.message}`,
                        data
                    );
                    return false;
                }
            } catch (error) {
                console.error(`Error testing ${name}:`, error);
                addResult(
                    name,
                    false,
                    `üí• Network/System Error: ${error.message}`, {
                        error: error.message,
                        url: url,
                        method: method,
                        tip: 'Check browser console (F12) for more details'
                    }
                );
                return false;
            }
        }

        async function testLogin() {
            document.getElementById('authResults').innerHTML = '<p class="text-info">üîÑ Testing login...</p>';

            const success = await testEndpoint(
                'Admin Login',
                API_BASE + 'auth/login.php',
                'POST', {
                    email: 'adminsofia@gmail.com',
                    password: 'password'
                },
                false,
            );

            if (success) {
                addInfo('Login successful! You can now test other endpoints.', 'authResults');
                setTimeout(checkSessionStatus, 500);
            } else {
                addInfo('‚ùå Login failed. Check if XAMPP MySQL is running and database exists.', 'authResults');
            }
        }

        async function checkSession() {
            document.getElementById('authResults').innerHTML = '<p class="text-info">üîÑ Checking session...</p>';
            await testEndpoint('Session Check', API_BASE + 'auth/check.php', 'GET', null, false);
            setTimeout(checkSessionStatus, 500);
        }

        async function testLogout() {
            document.getElementById('authResults').innerHTML = '<p class="text-info">üîÑ Testing logout...</p>';
            await testEndpoint('Admin Logout', API_BASE + 'auth/logout.php', 'POST', null, false);
            setTimeout(checkSessionStatus, 500);
        }

        async function runAllTests() {
            document.getElementById('testResults').innerHTML = '<p class="text-info">üîÑ Running comprehensive tests...</p>';

            if (!isLoggedIn) {
                addInfo('‚ö†Ô∏è You are not logged in. Some tests may fail. Please login first!');
            }

            // Test endpoints
            addInfo('Testing Bookings endpoint...');
            await testEndpoint('Get Bookings', API_BASE + 'bookings/index.php');

            addInfo('Testing Clients endpoint...');
            await testEndpoint('Get Clients', API_BASE + 'clients/index.php');

            addInfo('Testing Menus endpoint...');
            await testEndpoint('Get Menus', API_BASE + 'menus/index.php');

            addInfo('Testing Packages endpoint...');
            await testEndpoint('Get Packages', API_BASE + 'packages/index.php');

            addInfo('Testing Quotations endpoint...');
            await testEndpoint('Get Quotations', API_BASE + 'quotations/index.php');

            addInfo('‚úÖ All tests completed!');
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('authResults').innerHTML = '';
        }
    </script>
</body>

</html>